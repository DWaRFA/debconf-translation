#!/bin/sh
# This is a sample config module. It approximates 
# the questions asked in the postinst of cvs.
PATH=$PATH:client

# Establish the preliminaries.
dpkg-frontend --can-backup --init --title "CVS Configuration"

get_rotate_individual () {
	# Check to see if they said to select repositories individually
	# to rotate history files.
	ROTATE=`dpkg-frontend --get cvs/rotatehistory`
	if [ "$ROTATE" = "individual" ]; then
		echo BEGINBLOCK
		read
		echo TEXT low Select which history files to rotate.
		read
		for R in "$REPOSITORIES"; do
			echo MAPPING cvs/rotate/$R cvs/rotateindividual
			read
			echo INPUT low cvs/rotate/$R
			read
		done
		echo ENDBLOCK
		read
		echo GO
		read RET
					
		if [ "$RET" = "back" ]; then
			get_misc
			exit
		fi
	fi
}

get_misc () {
	# $REPOSITORIES is set as a side effect of get_repositories.
	if [ "$REPOSITORIES" ]; then
		echo BEGINBLOCK
		read
		echo INPUT low cvs/rotatehistory
		read
		echo INPUT medium cvs/pserver
		read
		echo ENDBLOCK
		read
		echo GO
		read RET

		if [ "$RET" = "back" ]; then
			get_repositories
			exit
		fi
		
		get_rotate_individual
	fi	
}

get_repositories () {
	if ! dpkg-frontend [ $MESSAGE --priority ${PRIORITY:-medium} \
		--input cvs/repositories ] --go ; then
		echo fail
		# Going back at this point is up to the frontend,
		# since it involves jumping out of this configmodule.
		# This is just a placeholder for something not in the spec.
#		dpkg-frontend --previous_module
		exit
	fi
	# Verify the data they entered - each element must be a
	# unique directory name.
	BAD=""
	# This assumes they entered the filenames separated by spaces..
	exec 3>&1
	for R in `dpkg-frontend --get cvs/repositories 2>&1 1>&3`; do
		if [ ! -d "$R" -o ! -d "$R/CVSROOT" ]; then
			BAD="$R $BAD"
		fi
	done
	if [ "$BAD" ]; then
		MESSAGE="--priority high --text Some of the repositiories are invalid. The following ones are not directories or do not contain a CVSROOT subdirectory: $BAD"
		# Recurse until they get it right.
		get_repositories
		exit
	fi
	
	# Proceed to rest of the questions.
	get_misc
}

# This launches the whole thing.
get_repositories
