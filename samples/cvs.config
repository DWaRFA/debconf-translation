#!/bin/sh
# This is a sample config module. It approximates 
# the questions asked in the postinst of cvs.

# Establish the preliminaries.
echo VERSION 1.0
read VERSION
echo CAPB backup
read CAPB
echo TITLE CVS Configuration
read

get_rotate_individual () {
	# Check to see if they said to select repositories individually
	# to rotate history files.
	echo GET cvs/rotatehistory
	read ROTATE
	if [ "$ROTATE" = "individual" ]; then
		echo BEGINBLOCK
		read
		echo TEXT low Select which history files to rotate.
		read
		for R in "$REPOSITORIES"; do
			echo MAPPING cvs/rotate/$R cvs/rotateindividual
			read
			echo INPUT low cvs/rotate/$R
			read
		done
		echo ENDBLOCK
		read
		echo GO
		read RET
					
		if [ "$RET" = "back" ]; then
			get_misc
			exit
		fi
	fi
}

get_misc () {
	# $REPOSITORIES is set as a side effect of get_repositories.
	if [ "$REPOSITORIES" ]; then
		echo BEGINBLOCK
		read
		echo INPUT low cvs/rotatehistory
		read
		echo INPUT medium cvs/pserver
		read
		echo ENDBLOCK
		read
		echo GO
		read RET

		if [ "$RET" = "back" ]; then
			get_repositories
			exit
		fi
		
		get_rotate_individual
	fi	
}

get_repositories () {
	echo BEGINBLOCK
	read
	if [ "$MESSAGE" ]; then
		echo TEXT high $MESSAGE
		read
	fi
	echo INPUT ${PRIORITY:-medium} cvs/repositories
	read
	echo ENDBLOCK
	read
	echo GO
	read RET

	# Going back at this point is up to the frontend,
	# since it involves jumping out of this configmodule.
	if [ "$RET" = "back" ]; then
		# This is just a placeholder for something not in the spec.
		echo PREVIOUS_MODULE
		read
		exit
	fi

	# Verify the data they entered - each list element must be a
	# unique directory name. 
	echo GET cvs/repositories
	read REPOSITORIES
	BAD=""
	# Assuming I get lists back space-separated...
	for R in $REPOSITORIES; do
		if [ ! -d "$R" -o ! -d "$R/CVSROOT" ]; then
			BAD="$R $BAD"
		fi
	done
	if [ "$BAD" ]; then
		MESSAGE="Some of the repositiories are invalid. The following ones are not directories or do not contain a CVSROOT subdirectory: $BAD"
		# Recurse until they get it right.
		get_repositories
		exit
	fi
	
	# Proceed to rest of the questions.
	get_misc
}

# This launches the whole thing.
get_repositories
