#!/bin/sh -e
# This is a sample config module. It approximates 
# the questions asked in the postinst of cvs.
PATH=$PATH:Client
if [ -e Client/confmodule.sh ]; then
	. Client/confmodule.sh
else
	. /usr/share/debconf/confmodule.sh
fi

# Establish the preliminaries.
db_version
db_capb 'backup'
#db_title 'CVS Configuration'

get_rotate_individual () {
	# Check to see if they said to select repositories individually
	# to rotate history files.
	db_get 'cvs/rotatehistory'
	if [ "$RET" = "individual" ]; then
		# Add mappings for each repository pointing at the
		# cvs/rotateindividual question. Build up a set of questions to
		# ask, one per repository.
		db_beginblock
		db_get 'cvs/repositories'
		for R in $RET; do
			RCODE=`echo $R | sed 's|/|_|g'`
			# Set up a new question to deal with this repository.
			db_register "cvs/rotateindividual" "cvs/rotate/$RCODE"
			db_subst "cvs/rotate/$RCODE" "repository" "$R"
			db_input "medium" "cvs/rotate/$RCODE"
		done

		db_endblock
		db_go
		if [ "$RET" = 'back' ]; then
			get_misc
			exit
		fi
	fi
}

# Pass in the repositories to use.
get_misc () {
	db_get 'cvs/repositories'
	if [ "$RET" != "" ]; then
		db_beginblock
		db_input 'low' 'cvs/rotatehistory'
		db_input 'medium' 'cvs/pserver'
		db_endblock
		db_go
		if [ "$RET" = 'back' ]; then
			get_repositories 'medium'
			exit
		fi
		
		get_rotate_individual
	fi	
}

# Pass in the priority to use.
get_repositories () {
	db_input $1 cvs/repositories
	db_go
	if [ "$RET" = 'back' ]; then
		# Going back at this point is up to the frontend,
		# since it involves jumping out of this configmodule.
		# This is just a placeholder for something not in the spec.
		previous_module
		exit
	fi
	# Verify the data they entered - each element must be a
	# unique directory name.
	BAD=""
	# This assumes they entered the filenames separated by spaces..
	db_get cvs/repositories
	for R in $RET; do
		if [ ! -d "$R" -o ! -d "$R/CVSROOT" ]; then
			BAD="$BAD $R"
		fi
	done
	if [ "$BAD" ]; then
		# Kill the isdefault flag so the item is show to the user again
		# though they've already answered it.
		db_fset cvs/repositories isdefault true
		db_fset cvs/badrepositories isdefault true
		db_subst cvs/badrepositories badreps "$BAD"
		db_input high cvs/badrepositories
		# Recurse until they get it right
		get_repositories high
		exit
	fi
	
	# Proceed to rest of the questions.
	get_misc
}

# This launches the whole thing.
get_repositories medium
