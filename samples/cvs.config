#!/bin/sh
# This is a sample config module. It approximates 
# the questions asked in the postinst of cvs.
PATH=$PATH:Client

# Establish the preliminaries.
dpkg-frontend --can-backup --init --title "CVS Configuration"

# Set up for later --get calls.
exec 3>&1

get_rotate_individual () {
	# Check to see if they said to select repositories individually
	# to rotate history files.
	if [ "`dpkg-frontend --get cvs/rotatehistory 2>&1 1>&3`" = "individual" ]; then
		# Add mappings for each repository pointing at the
		# cvs/rotateindividual question. Build up a set of questions to
		# ask, one per repository.
		dpkg-frontend [ \
			--priority low \
			--text "Select which history files to rotate."
		for R in `dpkg-frontend --get cvs/repositories 2>&1 1>&3`; do
			dpkg-frontend --register cvs/rotateindividual:cvs/rotate/$R
			dpkg-frontend --text $R --input cvs/rotate/$R
		done

		if ! dpkg-frontend ] --go; then
			get_misc
			exit
		fi
	fi
}

# Pass in the repositories to use.
get_misc () {
	if [ "`dpkg-frontend --get cvs/repositories 2>&1 1>&3`" ]; then
		if ! dpkg-frontend [ \
			--priority low --input cvs/rotatehistory \
			--priority medium --input cvs/pserver ] --go
		then
			get_repositories
			exit
		fi
		
		get_rotate_individual
	fi	
}

get_repositories () {
	if ! eval dpkg-frontend [ --priority medium $MESSAGE \
		--input cvs/repositories ] --go ; then
		echo fail
		# Going back at this point is up to the frontend,
		# since it involves jumping out of this configmodule.
		# This is just a placeholder for something not in the spec.
		dpkg-frontend --previous_module
		exit
	fi
	# Verify the data they entered - each element must be a
	# unique directory name.
	BAD=""
	# This assumes they entered the filenames separated by spaces..
	for R in `dpkg-frontend --get cvs/repositories 2>&1 1>&3`; do
		if [ ! -d "$R" -o ! -d "$R/CVSROOT" ]; then
			BAD="$R $BAD"
		fi
	done
	if [ "$BAD" ]; then
		MESSAGE="--priority high --text 'Some of the repositiories are invalid. The following ones are not directories or do not contain a CVSROOT subdirectory: $BAD'"		# Recurse until they get it right.
		get_repositories
		exit
	fi
	
	# Proceed to rest of the questions.
	get_misc
}

# This launches the whole thing.
get_repositories
