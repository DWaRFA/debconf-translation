#!/usr/bin/perl
#
# Slrn configurator program. By Joey Hess, <joeyh@master.debian.org>
# Pass in --ask-only to make it only ask questions, not act on the results.

use lib 'client';
use ConfModule ':all';
start_frontend; # Make sure it is running.
my $capb=capb('backup');
title('Slrn configuration');

my $act=1;
if ($ARGV[1] eq '--ask-only') {
	$act='';
}

sub fix_ip_up {
	return unless $act;
	
	# Remove slrn modified sections from /etc/ppp/ip-up.
	# This is left in (forever) for backwards compatability with old versions
	# of this script that modified /etc/ppp/ip-up. Now we use the ip-ip.d
	# directory, instead.
	return if ! -f "/etc/ppp/ip-up";
	open (IPUP,"</etc/ppp/ip-up") or die "Unable to read /etc/ppp/ip-up:$!\n";
	my @lines=<IPUP>;
	close IPUP;
	open (IPUP,">/etc/ppp/ip-up") or die "Unable to write /etc/ppp/ip-up:$!\n";
	my $ignore=undef;
	foreach (@lines) {
		if ((/# begin: GETDESC_WITH_PPP/ ne undef) ||
		    (/# begin: SLRNPULL_WITH_PPP/ ne undef)) {
			$ignore=1;
		}
		elsif ((/# end: GETDESC_WITH_PPP/ ne undef) ||
		       (/# end: SLRNPULL_WITH_PPP/ ne undef)) {
			$ignore=undef;
		}
		elsif (!$ignore) {
			print IPUP $_;
		}
	}
	close IPUP;
}

# This file needs to be set up right.
sub nntpserver {
	if (! -f "/etc/news/server") {
		my $nntpserver=get('news/server');
		# If there is no server set, try to guess a good value.
		if ($nntpserver eq '' &&
		    `hostname -f 2>/dev/null`=~m/(?:.*?\.)?(.*\.\w+)/) {
			set("news/server", "news.$1");
		}

		# Now prompt for the news server.
		input('medium', 'news/server');
		go;
		$nntpserver=get('news/server');
		return unless $act;
		open (NNTPSERVER,">/etc/news/server")
			or die "Unable to write to /etc/news/server: $!";
		print NNTPSERVER $nntpserver."\n";
		close NNTPSERVER;
	}
}

# Just prompt for the slrn/getdescs variable and tell them what to do if they
# choose manual.
sub getdescs {
	input('low', 'slrn/getdescs');
	go;
	if (get('slrn/getdescs') eq 'manually') {
		note('low', join ' ',
			'You indicated that you want to refresh newsgroup',
			'descriptions by hand, rather than automatically via',
			'a cron job or other method. The command to run (as',
			'root) to update the newsgroup descriptions is:',
			'/usr/sbin/slrn_getdesc. You should run this every',
			'week or so while you\'re online. If you prefer to',
			'switch back to having it run automatically, simply',
			'run /usr/sbin/slrnconfig.'
		);
	}
}

# See if now is a good time to refresh the descriptions.
sub getdescs_now {
	return if -f '/var/lib/slrn/newsgroups.dsc';
	
	# Throw away previous value. I want it fresh.
	set('news/server', 'false') unless $act;
	
	input('low', 'slrn/getdescs_now');
	go;
	if ($act && get('news/server') eq 'true') {
		system "/usr/sbin/slrn_getdescs >/dev/null";
	}
}

fix_ip_up();
nntpserver();
getdescs();
getdescs_now();
